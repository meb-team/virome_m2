# Viral metagenomics data mining Pipeline

This pipeline was developed to explore viral metagenomics across various ecosystems.
Through data mining approaches, we aimed to characterize as much viral information as possible from the environments under study.

The main objectives include the prediction of gene transfer agents (GTAs), the identification of auxiliary metabolic genes (AMGs), and the investigation of viral dark 
matter — a collection of sequences with no known homologs in current databases. Using these insights, we aim to identify ecosystems of particular interest, characterized 
by a high proportion of uncharacterized sequences and atypical viral elements such as GTAs and AMGs.

To achieve this, a comprehensive pipeline encompassing all these analyses was created.
It is structured into six distinct modules, each addressing a specific aspect of the study.

## Module 00

The first module is dedicated to the preprocessing and standardization of raw input data.

This pipeline was applied to metagenomic assemblies derived from various microbiomes. Prior to its execution, viral contig prediction was performed 
using three independent tools: [VirSorter2](https://github.com/jiarong/VirSorter2), [VIBRANT](https://github.com/AnantharamanLab/VIBRANT), and [DeepVirFinder](https://github.com/jessieren/DeepVirFinder).

This module retrieves the contigs identified as viral by at least one of these tools, organizes them by ecosystem type and then by sequencing 
run for downstream processing.

At the end of this module, the user obtains a set of FASTA files, each corresponding to a sequencing run and containing all contigs predicted as viral by at least 
one of the three detection tools.

## Module 01

This module focuses on quality assessment and filtering of predicted viral contigs, aiming to eliminate potential false positives generated by prediction tools.

To this end, all candidate viral contigs are first processed with CheckV, which performs the following tasks:

- Estimates genome completeness
- Removes potential bacterial contamination, particularly in the case of prophages.

The resulting high-quality viral sequences are then clustered independently of ecosystem origin using a threshold of 95% Average Nucleotide Identity (ANI) and 85% alignment coverage. This step yields viral Operational Taxonomic Units (vOTUs) by identifying a representative sequence for each cluster.

Further filtering is applied to the resulting clusters:

- Low-completeness singletons are discarded,
- Clusters predicted by only one tool are excluded to ensure confidence in viral identity, implementing a double or triple prediction validation strategy.
    However, high-completeness singletons (≥90%) are retained for downstream analyses.

This rigorous filtering enhances the reliability of the viral dataset and ensures a high-confidence set of vOTUs for subsequent functional and ecological investigations.

## Module 02

This module is dedicated to the taxonomic annotation of the representative viral sequences (vOTUs).

The annotation process is performed in two sequential steps:

- Primary taxonomic assignment is carried out using the RefSeq Viral database.
- Unclassified vOTUs are subsequently queried against the IMG/VR v4 database to potentially recover additional taxonomic information.

For each ecosystem, a taxonomic summary report is generated, providing detailed annotations for each vOTU, which supports comparative analyses of viral community 
structure across environments.

## Module 03

This optional module is executed in parallel and sequentially alongside the main processing steps of the pipeline.
Its purpose is to perform descriptive statistical analyses on both the input data and intermediate results at each stage of the workflow.

These analyses provide ongoing insights into dataset composition, processing efficiency, and the evolving characteristics of the viral 
sequences, facilitating both quality control and biological interpretation throughout the pipeline.

## Module 04 

This penultimate module focuses on the functional annotation of predicted proteins encoded by the vOTU sequences.

The workflow begins with gene prediction using [Prodigal](https://github.com/hyattpd/Prodigal), followed by functional annotation via [eggNOG-mapper](https://github.com/eggnogdb/eggnog-mapper). 
This tool provides comprehensive information on:

- KEGG Orthology (KO).
- Gene Ontology (GO) terms.
- Protein family assignments (PFAMs).

Based on these annotations, we also perform the prediction of auxiliary metabolic genes (AMGs), which are viral genes implicated in the modulation of host metabolic 
pathways and play a critical role in the regulation of biogeochemical cycles in ecosystems.

At the end of this module, a tab-delimited summary file is generated, listing the predicted AMGs and organizing them by ecosystem, enabling downstream ecological 
and comparative analyses.

## Module 05

This final module complements Module 2 by addressing potential taxonomic misassignments and focusing on the detection of gene transfer agents (GTAs) within the dataset.
We are using [GTA-Hunter](https://github.com/kogayr/GTA-Hunter) tool.

GTAs are phage-like elements capable of mediating horizontal gene transfer, and due to their strong resemblance to prophages, they can be misclassified in 
viral metagenomic analyses. To account for this, this module re-examines both:

- Filtered-out sequences from the quality control step,
- Taxonomically assigned vOTUs, including those confidently classified as viral.

By applying dedicated GTA prediction strategies to the entire unfiltered dataset, this step aims to:

- Quantify the actual proportion of GTAs across ecosystems,
- Identify potential taxonomic misannotations,
- Assess database-induced biases that may impact the accuracy of viral community profiling.

This module provides critical insight into the prevalence and ecological significance of GTAs, and helps refine the interpretation of taxonomic and 
functional data derived from viral metagenomes.


